# 【MySQL】索引


## 什么是索引

索引，就是帮助`MySQL`高效获取数据的数据结构。

## 索引的优势和劣势

### 1. 优势

- 可以提高数据的检索效率，降低数据库的`IO`成本。

- 可以降低数据排序的成本，降低`CPU`消耗

### 2. 劣势

- 索引也是一张表，存储了主键和索引字段，因此，索引也占用空间。

- 索引虽然提高了查询效率，但是降低了更新的速度。因为进行增、删、改时，不但需要更新数据，还需要更新索引。

- 索引不是所有情况均适用。如表中数据较少，字段频繁更新，字段很少使用，或者字段大量重复等，都不适合建立索引。


## 索引结构

索引是在`MySQL`的存储引擎层实现的，目前支持的索引结构如下：

- `BTree`索引：是一类统称，包含`B+`树等。`InnoDB`、`MyISAM`、`Memory`都支持。

- `HASH`索引：`Memory`支持。

- `R-tree`索引：空间索引，`MyISAM`支持，主要用于地理空间数据类型。

- `Full-text`索引：全文索引，`MyISAM`支持，`InnoDB`从`MySQL5.6`版本开始支持。

聚集索引、符合索引、前缀索引、唯一索引默认使用`B+tree`树结构组织的索引。


## `B-`树

`B-`树又叫多路平衡搜索树，一颗`m`叉`B-`树的性质如下：

1. 每个结点最多有m个分支。

2. 非叶子结点的根结点，至少有2个分支。非根非叶子结点，至少有`ceil(m/2)`个分支。

3. 有n个分支的结点，具有n-1个关键字，这些关键字按递增或者递减顺序排列。

4. 结点内的关键字互不相等。

5. 叶子结点都处于同一层，可以用空指针表示。

6. `B-`树的阶数`m`，是认为规定的，不会因为结点关键字的最大个数而变化。

7. 结点中的每个关键字，都对应着一个记录的存储地址。


## `B+`树

一颗`m`叉`B+`树，具备如下性质：

1. 具有n个关键字的结点，含有n个分支。

2. 每个结点最多有m个分支。

3. 非根非叶子结点，至少有`ceil(m/2)`个关键字。非叶子结点的根结点，至少有2个关键字。

4. 叶子结点包含了全部关键字，关键字顺序排列。并且叶子结点引出的指针，指向了具体的记录。

5. 所有非叶子结点中，存储着子树的最大关键字和指向该子树的指针，不存储关键字对应记录的存储地址。即非叶子结点仅仅发挥着索引作用。

6. 有一个指针指向关键字最小的叶子结点，所有叶子结点组成一个线性链表。


## `MySQL`中的`B+`树

`MySQL`的`B+`树中，叶子结点是双向循环链表。


## 索引分类

1. 单值索引
   
   一个索引只包含单个列，一个表可以有多个单列索引。

2. 唯一索引
   
   索引列的值必须唯一，但允许有空格。

3. 复合索引
   
   一个索引包含多个列。


## 索引管理

### 1. 索引创建

可以在创建表结构时创建索引，也可以建完表后再增加。

创建语法为：

```sql
CREATE [UNIQUE | FULLTEXT | SPATIAL] INDEX index_name ON table_name(index_col_name...);
```

`index_col_name`可以指定字段的长度，并指明字段的排序规则，格式如下：

```sql
column_name[ (length) ][ASC | DESC]
```

### 2. 查看索引

```sql
SHOW INDEX FROM 表名;
```

### 3. 删除索引

```sql
DROP INDEX 索引名 ON 表名;
```

### 4. `ALTER`更新索引

- 创建主键索引：
  
  ```sql
  ALTER TABLE table_name ADD PRIMARY KEY(column_list);
  ```

- 创建唯一索引
  
  ```sql
  ALTER TABLE table_name ADD UNIQUE index_name(column_list);
  ```

- 创建普通索引
  
  ```sql
  ALTER TABLE table_name ADD INDEX index_name(column_list);
  ```

- 创建全文索引
  
  ```sql
  ALTER TABLE table_name ADD FULLTEXT index_name(column_list);
  ```

### 5. `CREATE TABLE`创建索引

使用`CREATE TABLE`语句创建表时，添加以下语句即可建立索引。

- 创建主键索引
  
  ```sql
  PRIMARY KEY (column_list)
  ```

- 创建普通索引
  
  ```sql
  KEY | INDEX [index_name] (column_list)
  ```

- 创建唯一索引
  
  ```sql
  UNIQUE [ INDEX | KEY ] [index_name] (column_list)
  ```


## 索引设计原则

1. 对于查询频率高、且数据量大的表，可以建立索引。

2. 索引字段，应该选择最常用、过滤效果最好的组合。

3. 尽量使用唯一索引，区分度越高，索引的效果越好。

4. 不应该创建太多索引。索引越多，更新、插入、删除操作的效率越低。索引太多，`MySQL`生成执行计划时选择会过多，代价太高。

5. 尽量使用短索引。索引也是存储在磁盘中，如果索引长度较短，既能节约存储空间，也能提升访问索引的`IO`效率。

6. 充分利用最左前缀原则。

7. 如果某个数据列包含许多重复内容，建立索引则没有什么实际效果。索引的选择性是指索引列中不同值的数据与表中记录数的比。一个索引的选择性越接近1，这个索引的效率就越高。


## 索引的使用

1. 尽量使用符合索引，少使用单列索引。

2. 如果建立了多个索引，数据库会选择一个最优的索引，不会使用全部索引。

